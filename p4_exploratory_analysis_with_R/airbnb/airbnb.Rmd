Airbnb Listing Analysis by Gisle Tveit Gaasemyr
========================================================

> **Tip**: You will see quoted sections like this throughout the template to
help you construct your report. Make sure that you remove these notes before
you finish and submit your project!

> **Tip**: One of the requirements of this project is that your code follows
good formatting techniques, including limiting your lines to 80 characters or
less. If you're using RStudio, go into Preferences \> Code \> Display to set up
a margin line to help you keep track of this guideline!

```{r echo=FALSE, message=FALSE, packages}
# Load all of the packages that you end up using in your analysis in this code
# chunk.

# Notice that the parameter "echo" was set to FALSE for this code chunk. This
# prevents the code from displaying in the knitted HTML output. You should set
# echo=FALSE for all code chunks in your file, unless it makes sense for your
# report to show the code that generated a particular plot.

# The other parameters for "message" and "warning" should also be set to FALSE
# for other code chunks once you have verified that each plot comes out as you
# want it to. This will clean up the flow of your report.

library(ggplot2)
library(tidyr)
library(dplyr)
library(scales)
library(gridExtra)
library(ggmap)
library(reshape2)

```

```{r echo=FALSE, Load_the_Data}
# Load the Data
airbnb = read.csv('data/airbnb_union.csv')
```

> **Tip**: [{remove}] Before you create any plots, it is a good idea to provide 
a short introduction into the dataset that you are planning to explore. Replace this
quoted text with that general information![{/remove}]

The dataset I have chosen consists of airbnb listing data from San Francisco 
collected at 28 different dates between November 2013 and July 2017. I originally 
downloaded the datasets from 
http://tomslee.net/airbnb-data-collection-get-the-data as individual files for 
each date, which I then combined into a single file. For more details on this, 
see union_script.R [add to repo].

For details on the content of the columns, see 
http://tomslee.net/airbnb-data-collection-get-the-data.

# Univariate Plots Section

> **Tip**: In this section, you should perform some preliminary exploration of
your dataset. Run some summaries of the data and create univariate plots to
understand the structure of the individual variables in your dataset. Don't
forget to add a comment after each plot or closely-related group of plots!
There should be multiple code chunks and text sections; the first one below is
just to help you get started.

I'll start my analysis by taking a look at some records to get an initial feel 
of the dataset.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
#Getting an initital look at some rows
head(airbnb)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
#Getting an initital look at some rowsggmap(myMap) +
tail(airbnb)
```

Next I'll get some information about the data types.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
str(airbnb)
```

 

```{r Univariate_Plots}
#Setting correct format for dates
airbnb$date_collected <- as.Date(airbnb$date_collected)

```

I now want to get some summary statistics for the different fields in the 
dataframe. 

```{r Univariate_Plots}
summary(airbnb)
```

```{r Univariate Plots}
#Removing column with all NA values
airbnb <- subset(airbnb, select = -borough)
```

I am already seeing some trends in the data. For example, based on the 1st 
quartile and max value for overall_satisfication, I suspect that very few 
listings have ratings below 4 of 5. Let's plot this to take a closer look.




```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}


plot <- ggplot(airbnb, aes(x = overall_satisfaction, fill = I('#099DD9') ) ) +
  geom_bar() +
  scale_x_continuous(breaks = seq(0,5,1)) +
  geom_text(stat='count',aes(
    label=scales::percent(..prop..),vjust=-0.5))

plot

```

The plot confirms my suspicion: 81.9% of the ratings are 4 or higher, with more 
than 50% of the ratings being 5. However, it is interesting to see that 16.8% of 
the rooms have a rating of 0. Let's take a closer look at some summary 
statistics for these records to see if there's a data quality issue.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
airbnb %>% 
  filter(overall_satisfaction==0) %>% 
  summary()
```
The first thing I notice is that there seem to be a large amount of records 
with 0 reviews. According to the dataset description the overall_satisfaction 
consists of " The average rating (out of five) that the listing has received from 
those visitors who left a review." We can therefore assume that records with 0 
reviews should have rating set to NA, not 0-5. Let's take a look at how many 
records have 0 reviews and an overall_satisfaction between 0 and 5.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}

#Count of records with 0 reviews and an overall_satisfaction between 0 and 5
airbnb %>% 
  filter(reviews == 0 & !is.na(overall_satisfaction)) %>% 
  nrow()

```

About 8% of the records match this criteria. Let's plot the overall_satisfaction 
for these records.

```{r echo=FALSE, Univariate_Plots}
data = filter(airbnb, reviews == 0 & !is.na(overall_satisfaction))

plot <- ggplot(data, aes(x = overall_satisfaction, fill = I('#099DD9') ) ) +
  geom_bar() +
  scale_x_continuous(breaks = seq(0,5,1)) +
  geom_text(stat='count',aes(
    label=scales::percent(..count../sum(..count..)),vjust=-0.5))

plot

```

It looks like all 0 reviews records with a value in overall_satisfaction has it 
set to 0. I'll run a filtered querry to make sure.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
airbnb %>% 
  filter(reviews == 0 & overall_satisfaction > 0)
```

3 out of 205k records is practically 0. I will now plot the overall_satisfaction 
column again excluding the 0 reviews records. I will also update the airbnb 
dataframe and change the overall_satisfaction score from 0 to NA for these 
records.

```{r include=FALSE, Univariate_Plots}
#For QA
pre_change <- airbnb %>% 
  group_by(overall_satisfaction) %>% 
  summarise(n = n())

#Changing the overall_satisfaction score of 0 reviews records to NA
airbnb$overall_satisfaction <- 
  if_else(airbnb$reviews == 0, NA_real_, airbnb$overall_satisfaction)

#For QA
post_change <- airbnb %>% 
  group_by(overall_satisfaction) %>% 
  summarise(n = n())

#QA
pre_change
post_change
pre_change - post_change

```


```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}

plot <- ggplot(filter(airbnb, reviews != 0), aes(x = overall_satisfaction, fill = I('#099DD9') ) ) +
  geom_bar() +
  scale_x_continuous(breaks = seq(0,5,1)) +
  geom_text(stat='count',aes(
    label=scales::percent(..count../sum(..count..)),vjust=-0.5))

plot
```
When excluding the zero reviews records, the percentage of records with an 
overall ranking of 0 goes down to 7.5. That's still a fair amount, but it's much 
more believeable than before. Let's run a summary query on these records to see 
if we can spot any trends.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
airbnb %>% 
  filter(overall_satisfaction==0, reviews != 0) %>% 
  summary()
```

What stands out to me is that a large portion of these records have only one 
review. Let's compare the amount of reviews of these records 
with the full dataset.

```{r}

#to be used or removed
filter(airbnb, reviews != 0) %>% 
  group_by(reviews) %>% 
  summarise(n = n())

20367 + 12907

9857			+
  8049			+
  6292			+
  5475			+
  4837	
```


```{r}

p1 = ggplot(filter(airbnb, overall_satisfaction == 0 & reviews != 0), aes(x = reviews, fill = I('#099DD9') ) ) +
  geom_bar() +
#  scale_x_continuous(breaks = seq(0,5,1)) +
  geom_text(stat='count',aes(
    label=scales::percent(..count../sum(..count..)),vjust=-0.5))

p2 = ggplot(filter(airbnb, reviews != 0), aes(x = reviews, fill = I('#099DD9') ) ) +
  geom_histogram(binwidth = 5) +
#   stat_bin(binwidth= 5, geom="text", aes(label = ..count.., y = 0.98*(..count..)) , 
# vjust = -1) +
  geom_text(stat='bin', binwidth=aes(
    label=scales::percent(..count../sum(..count..)),vjust=-0.5)) +
  xlim(0,50) 
  # geom_text(stat='count',aes(
  #   label=scales::percent(..count../sum(..count..)),vjust=-0.5))

p2

grid.arrange(p1,p2,nrow = 1)

?stat_bin

```
[]noe her, fiks plot.[]
{gisle}
Next let's take a look at the price distribution.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
plot <- ggplot(airbnb, aes(x = price, fill = I('#099DD9') ) ) +
  geom_bar()# +
#  scale_x_continuous(breaks = seq(0,max(airbnb$price),1000))

plot
```

Looks like there's some extreme outliers for the price variable. Let's zoom in 
to get a better sense of price distribution

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
quantile(airbnb$price, probs = seq(0.95,1,0.01))
```

The 98th price percentile is at 1000, and I'll use that as the price cutoff to 
zoom in on the data.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
plot <- ggplot(airbnb, aes(x = price, fill = I('#099DD9') ) ) +
  geom_histogram(binwidth = 10) +
  xlim(0,1000)

plot
```
{gisle}

Setting the max price to 1000, which excludes the 2% most expensive units,
gives a clearer picture of the price distribution. The plot is heavily 
right-skewed, with most units being priced below 250.

I suspect size of the units heavily affect price. Therefore I will make a new 
column for price per bedroom.

```{r Univariate Plots}
# Creating the column
airbnb$price_per_bedroom = airbnb$price / airbnb$bedrooms

# Removing infinite values
is.na(airbnb$price_per_bedroom) <- do.call(cbind,lapply(airbnb$price_per_bedroom, is.infinite))

airbnb %>% 
  group_by(room_type) %>% 
  summarise(n = n(), avg_price = mean(price, na.rm = TRUE), 
            avg_bedroom_price = mean(price_per_bedroom, na.rm = TRUE))
```

Price_per_bedroom percentiles:
```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
quantile(airbnb$price_per_bedroom, probs = seq(0.95,1,0.01), na.rm = TRUE)
```

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
plot <- ggplot(airbnb, aes(x = price_per_bedroom, fill = I('#099DD9') ) ) +
  geom_histogram(binwidth = 10) +
  scale_x_continuous(limits = c(0,550),breaks = seq(0,600,100))

plot
```

Unsurprisingly, the trend is very similar for the price and price_per_bedroom 
plots: the distribution is heavily right-skewed.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
#bedrooms
plot <- ggplot(airbnb, aes(x = bedrooms, fill = I('#099DD9') ) ) +
  geom_bar() +
  scale_x_continuous(breaks = seq(0,max(subset(airbnb,!is.na(bedrooms))$bedrooms),1)) +
    geom_text(stat='count',aes(
    label= scales::percent(..prop..)), vjust=-0.5, hjust=0.4, size = 3.2)

plot

```

Almost two thirds of all units are one-room rentals. Room type is probably a 
factor here. I will revisit this in the bivariate plots section.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
plot <- ggplot(airbnb, aes(x = room_type, fill = I('#099DD9') ) ) +
  geom_bar()

plot

```

Almost all units have either room_type Entire home/apt and Private room. Later 
on it will be interesting to see if this changes over time.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
#minstay
plot <- ggplot(airbnb, aes(x = minstay, fill = I('#099DD9') ) ) +
  geom_bar()

plot
```

Minstay percentiles:
```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
quantile(airbnb$minstay, probs = seq(0.95,1,0.01), na.rm = TRUE)

```

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
#minstay excluding units with 2% highest minstay values.
plot +
  scale_x_continuous(limits = c(0,31), breaks = seq(0,31,1))
```

It looks like most Airbnb hosts require a minimum stay between 1 and 3 nights, 
with few units requiring more than 7 nights. It is interesting to see that many 
more units have a minimum stay of 7 and 30 nights than 6 nights, which is natural 
considering there are 7 days in a week, and (roughly) 30 days in a month. There 
is also a slight increase at 10 days (round number) and 14 days (2 weeks). 


```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots}
#accommodates
plot <- ggplot(airbnb, aes(x = accommodates, fill = I('#099DD9') ) ) +
  geom_bar()
#  scale_x_continuous(breaks = seq(0,max(subset(airbnb,!is.na(bedrooms))$bedrooms),1))

plot
```
```{r}
#accommodates
plot <- ggplot(airbnb, aes(x = reorder(neighborhood, neighborhood, FUN = length), fill = I('#099DD9') ) ) +
  geom_bar() + 
  coord_flip()

plot
```

The neighborhood distribution is very spread, with some very large and some very 
small neighborhoods. Although it is outside the scope of this project, it would 
be interesting to compare the neighborhood proportions in the airbnb dataset to 
population and housing data from San Francisco. This could reveal whether being 
an airbnb host is much more common in some neighborhoods compared to other 
neighborhoods.

```{r echo=FALSE, message=FALSE, warning=FALSE, Univariate_Plots} 
#accommodates
plot <- ggplot(airbnb, aes(x = accommodates, fill = I('#099DD9') ) ) +
  geom_bar()
#  scale_x_continuous(breaks = seq(0,max(subset(airbnb,!is.na(bedrooms))$bedrooms),1))

plot
```

While it is most common for units to accomadate 2 people, accomadating 4 people 
is also rather common. 

(gisle)

> **Tip**: Make sure that you leave a blank line between the start / end of
each code block and the end / start of your Markdown text so that it is
formatted nicely in the knitted text. Note as well that text on consecutive
lines is treated as a single space. Make sure you have a blank line between
your paragraphs so that they too are formatted for easy readability.

# Univariate Analysis

> **Tip**: Now that you've completed your univariate explorations, it's time to
reflect on and summarize what you've found. Use the questions below to help you
gather your observations and add your own if you have other thoughts!

### What is the structure of your dataset?
There are 205,532 Airbnb listings in the dataset. The listings were collected 
at 28 different dates between November 2013 and October 2017. Each record 
consists of 6 numeric, 2 nominal, and 2 ID variables (room_id and host_id). 
There are also 2 date columns and 2 columns with geographical location 
(longitude and lattitude). 

### What is/are the main feature(s) of interest in your dataset?

From my initial analysis I consider price and date to be the main features of 
interest in the data set. 

### What other features in the dataset do you think will help support your \
### investigation into your feature(s) of interest?
Price variations across neighborhoods will be interesting to take a look at. I 
believe number of bedrooms and room type are other interesting parameters which 
will greatly affect the price.

### Did you create any new variables from existing variables in the dataset?
Yes, I created price per bedroom, as that seemed to be the best indicator of 
size. Without taking unit size into account it is very hard to get a true price 
picture.

### Of the features you investigated, were there any unusual distributions? \
It is a little surprising to me how large the portion of 1 bedroom apartments 
is. More than half of the units on the market fit into this category. There's a 
chance some of these records really inform about the number of rooms available, 
not the actual amount of rooms in the unit. It will be interesting to later take
 a look at the bedroom distribution across room type.

### Did you perform any operations on the data to tidy, adjust, or change the form \
### of the data? If so, why did you do this?
Yes. I initially downloaded 28 separate files which I merged to one file using 
the tidy function union. For full details about this process, see [filename].

In the file you are reading now I have changed the data type of the 
date_collected column from factor to date. I also removed one "dead" variable, 
borough, as all the values were set to NA. During my analysis I found a data 
error which I corrected: 15 945 records with 0 reviews did not have 
overall_satisfaction set to NA, and >99.9% of these records had 
overall_satisfaction set to 0. I changed the overall_satisfaction of these 
records to NA.

# Bivariate Plots Section

> **Tip**: Based on what you saw in the univariate plots, what relationships
between variables might be interesting to look at in this section? Don't limit
yourself to relationships between a main output feature and one of the
supporting variables. Try to look at relationships between supporting variables
as well.

In this section, among other things I want to take a closer look at the 
relationship between price and neighborhood, and price and time.

Before I go any further, I want to make sure the neighborhood data is correct. 
Since the dataset contains latitude and longitude data, this is fairly easy to 
check using a map plot.

```{r fig.height=6, fig.width=6, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
myLocation <- "San Francisco"

myMap <- get_map(location = c(lon= -122.431297,lat = 37.773972), 
                 source = "google", 
                 maptype = 'terrain', crop = FALSE, zoom = 12)

ggmap(myMap) +
geom_jitter(alpha = 0.01, aes(x=longitude, y=latitude), 
           data= airbnb) +
  facet_wrap(~neighborhood)

```

This is the result I was hoping for. The data points are nicely clustered within 
their respective neighborhoods. Based on local knowledge I can confirm that the 
names of the neighborhoods are correct.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

  ggplot(airbnb, aes(y = price)) +
  geom_bar(stat = 'summary', fun.y = mean, aes(x = reorder(neighborhood, price))) +
  coord_flip()

```
(gisle)
```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
airbnb %>% 
  group_by(neighborhood) %>% 
  summarise(n = n(), mean = mean(price), med = median(price), 
            min = min(price), max = max(price)) %>% 
  arrange(desc(mean))
```


Presidio Heights and Presidio are clearly the most expensive neighborhoods, 
with an average price per night above $440. The most affordable neighborhods are 
Treasure Island, Crocker Amazon and Lakeshore. This makes sense, as they are all 
on the outskirts of the San Francisco city limits. Based on my local knowledge of 
the city there are no surprises in this figure.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

plot <- ggplot(airbnb, aes(y = price)) +
  geom_bar(stat = 'summary', fun.y = mean, 
           aes(x = reorder(neighborhood, price), fill = I('gray50'))) +
  geom_bar(stat = 'summary', fun.y = mean, 
           aes(x = reorder(neighborhood, price),
               y = price_per_bedroom, fill = I('deepskyblue'))) +
  coord_flip()

legend <- scale_fill_manual(name = 'Variable', values = 
                      c('gray50'='gray50', 'deepskyblue'='deepskyblue'), 
                    labels = c('gray50'='Price', 
                               'deepskyblue'='Price per bedroom'), 
                    breaks = c('gray50','deepskyblue'))

plot + legend

?guides
```
(gisle)
When we compare the price to price per bedroom, Presidio Heights is no longer 
the most expensive neighborhoods. Now it seems like Downtown and the Financial 
District has the most expensive units. One thing to note is that this plot 
excludes any units with zero bedrooms  (roughly 13% of the records). Let's see 
if looking at median instead of mean changes things.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

plot <- ggplot(airbnb, aes(y = price)) +
  geom_bar(stat = 'summary', fun.y = median, 
           aes(x = reorder(neighborhood, price, FUN = median), fill = I('gray50'))) +
  geom_bar(stat = 'summary', fun.y = median, 
           aes(x = reorder(neighborhood, price,  FUN = median),
               y = price_per_bedroom, fill = I('deepskyblue'))) +
  coord_flip() +
  labs(x = 'Neighborhood')

plot + legend

```

Looking at median instead of mean, the situation changes quite a bit. 
For absolute price, Presidio Heights and Presidio drop to 4th and 5th places, 
while Marina, Pacific Heights and Russian Hill now occupy the top 3. Presidio 
has the highest price per bedroom, with Marina and Chinatown having the 2nd and 
3rd highest bedroom price.

Comparing the mean and median plots, it seems like some neighborhoods have some 
very expensive units, increasing the mean values. Especially Presidio and 
Presidio Heights seems to be affected by this. It doesn't seem to be same case 
the other way around, as all neighborhoods seem to have a higher mean than 
median price. Lets create another plot to confirm this.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
plot <- ggplot(airbnb, aes(y = price)) +
  geom_bar(stat = 'summary', fun.y = mean, 
           aes(x = reorder(neighborhood, price, FUN = mean), fill = I('gray50'))) +
  geom_bar(stat = 'summary', fun.y = median, 
           aes(x = reorder(neighborhood, price),
               fill = I('deepskyblue'))) +
  coord_flip() +
  labs(x = 'Neighborhood')

legend <- scale_fill_manual(name = 'Statistic', values = 
                      c('gray50'='gray50', 'deepskyblue'='deepskyblue'), 
                    labels = c('gray50'='Mean', 
                               'deepskyblue'='Median'), 
                    breaks = c('gray50','deepskyblue'))

plot +legend
```

As expected, no neighborhood has a higher median price than mean price. 

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
#Creating table for neighborhood price

neighborhood_price <- airbnb %>%
  group_by(neighborhood) %>% 
  summarise(n = n(), mean = mean(price), median = median(price), 
            min = min(price), max = max(price)) %>% 
  arrange(desc(mean))

neighborhood_price

#neighborhood_price$mean - 
  
neighborhood_price$med


plot <- ggplot(neighborhood_price, aes(y = (mean / median), x = reorder(neighborhood, (mean / median) ) )) +
  geom_bar(stat = 'identity') + 
  coord_flip()
  
plot
```

In this plot, which compares median and mean price per neighborhood, 
we see that the median price in Presidio Heights is almost 2.5 times greater 
than the mean price. From the univariate plot section I already know that the 
dataset has some large price outliers. A box plot might reveal whether the 
outliers are distributed across most or only a few neighborhoods.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Horizontal box plot, price and neighborhood
plot <- ggplot(airbnb, aes(y = price, x = reorder(neighborhood,price, FUN = mean))) +
  geom_boxplot(outlier.size = 0.5, outlier.alpha = 0.3) + 
  coord_flip()

plot
```

The otuliers are so dominating that it is hard to recognize this being a box 
plot. Let's exclude the top percentile and run the box plots again.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Horizontal box plot, price and neighborhood. Excluding top price percentile.
plot <- ggplot(filter(airbnb, price < quantile(airbnb$price,0.99)), 
               aes(y = price, x = reorder(neighborhood,price, FUN = mean))) +
  geom_boxplot(outlier.size = 0.5, outlier.alpha = 0.3) + 
  coord_flip()

plot
```

Even after excluding the most extreme (top 1%) prices most neighborhoods seem to 
have a lot of large outliers. Many neighborhoods have a relatively large spread 
of prices, and the prices for most neighborhoods are right-skewed.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
#Price over time, mean
plot <- ggplot(airbnb, aes(x = date_collected, y = price)) +
  geom_line(stat = 'summary', fun.y = mean) + 
  ylab('Mean price')

plot
```

Except for one outlier date in 2015, the mean price have stayed fairly consistent 
roughly between 210 and 270,over the whole time period in the dataset (late 2013 
to mid-2017). This makes me curious about whether there was a special event in 
San Francisco at the time the data was collected which increased the prices 
dramatically, or if this is due to some outliers. Let's see if the median price 
follows the same trend.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
#Price over time, median
plot <- ggplot(airbnb, aes(x = date_collected, y = price)) +
  geom_line(stat = 'summary', fun.y = median) + 
  ylab('Median price')

plot
```

At first glance the median price appears to be much more volatile than the mean 
price, but this is mainly due to the y axis being much more narrow in this 
last plot. Let's plot the statistics together to get a clearer picture.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Mean vs median price over time
plot <- ggplot(airbnb, aes(x = date_collected, y = price)) +
  geom_line(stat = 'summary', fun.y = mean, aes(color = I('blue'))) +
  geom_line(stat = 'summary', fun.y = median,  aes(color = I('forestgreen'))) +
  theme_light()

legend <- scale_color_manual(name = 'Statistic', 
                             values =c('blue'='blue', 
                                       'forestgreen'='forestgreen'), 
                    labels = c('blue'='Mean', 'forestgreen'='Median'))

plot + legend
```

Here we see that median price in general follows the trend of the mean price. 
One interesting exception is the outlier date from the mean chart, which is not 
an outlier for median price. To me this indicates that the 2015 outlier date has 
some very high outlier prices. Let's investigate this further.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
#Number of records per date
plot <- ggplot(airbnb, aes(x=date_collected)) + 
  geom_line(stat= 'count') +
  geom_point(stat='count')

```

There is not an unusal number of records for any dates in 2015, so record count 
is probably not a relevant factor. Next I'll take a closer look at the data for 
the mean price outlier date.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Finding the outlier date
airbnb %>%
  group_by(date_collected) %>% 
  summarise(n = n(), mean = mean(price), median = median(price), 
            min = min(price), max = max(price)) %>% 
  arrange(desc(mean)) %>% 
  head()

```

2015-08-21 is the outlier date. 

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

print("Running the summary() function on all the records.")
summary(airbnb)

print('-----')

print("Running the summary() function on the 2015-08-21 records.")
subset(airbnb, date_collected == '2015-08-21') %>% 
  summary()

```

Here I'm mostly interested in comparing quantiles for price and 
price_per_bedroom. These variables are not drastically different between the 
2015-08-21 records and all records.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Boxplot of price per date
plot <- ggplot(airbnb, aes(x = date_collected, group = date_collected, y = price)) +
  geom_boxplot(outlier.size = 0.5, outlier.alpha = 0.3) + 
  scale_x_date(date_labels = "%b-%y", date_breaks = '6 months')

plot
```

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
plot <- ggplot(airbnb, aes(x = date_collected, group = date_collected, y = price)) +
  geom_boxplot(outlier.size = 0.5, outlier.alpha = 0.3) + 
  scale_x_date(date_labels = "%b-%y", date_breaks = '6 months') +
  ylim(0,10000) +
  ggtitle('Boxplot with price<=10000') +
  theme(title = element_text(size=9))

plot
```

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
plot <- ggplot(airbnb, aes(x = date_collected, group = date_collected, y = price)) +
  geom_boxplot(outlier.size = 0.5, outlier.alpha = 0.3) + 
  scale_x_date(date_labels = "%b-%y", date_breaks = '6 months') +
  ylim(0,1000) +
  ggtitle('Boxplot with price<=1000') +
  theme(title = element_text(size=9))

plot
```

The boxplots indicate that there are more outliers above price 1000 for 
2015-08-21 compared to the other dates.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Bar chart, top 5% prices date distribution
plot <- subset(airbnb, price >= quantile(airbnb$price, 0.95)) %>% 
  ggplot(aes(x = date_collected)) +
  geom_bar() +
  scale_x_date(date_labels = "%b-%y", date_breaks = '6 months') +
  ggtitle('Top 5% prices in dataset') +
  theme(title = element_text(size=9))

plot
```

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Bar chart, top 2% prices date distribution
plot <- subset(airbnb, price >= quantile(airbnb$price, 0.98)) %>% 
  ggplot(aes(x = date_collected)) +
  geom_bar() +
  scale_x_date(date_labels = "%b-%y", date_breaks = '6 months') +
  ggtitle('Top 2% prices in dataset') +
  theme(title = element_text(size=9))

plot
```

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Bar chart, top 1% prices date distribution
plot <- subset(airbnb, price >= quantile(airbnb$price, 0.99)) %>% 
  ggplot(aes(x = date_collected)) +
  geom_bar() +
  scale_x_date(date_labels = "%b-%y", date_breaks = '6 months') +
  ggtitle('Top 1% prices in dataset') +
  theme(title = element_text(size=9))

plot
```

Looking at the three bar charts above, we see that the August 2015 date does not 
have exceptionally many records with price higher than the top 5% prices in the 
whole dataset, but the August 2015 records do have a very large amount of the 
top 2% of prices in the dataset, and almost three times as many of the 1% top 
pricesas any other date in the dataset. Since this is showing absolute counts, 
and some of the later dates have more records than the August 2015 date, this 
becomes even more significant.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
#Percentile dataframe for all dates and the August 2015 date
df_percentiles = data.frame(all_records = quantile(airbnb$price, seq(0,1,0.01)),
           August_2015 = subset(
             airbnb, date_collected == '2015-08-21')$price %>% 
  quantile(seq(0,1,0.01)) )

#Creating row of numeric values for percentile for easier use with ggplot
df_percentiles$percentile <- seq(0,100,1)

```

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Plotting price percentiles, all records vs August 2015
melted = melt(df_percentiles,id = c('percentile'))

plot <- ggplot(melted, aes(x = percentile, y = value)) +
  geom_line(aes(color = variable), stat = 'identity') + 
  scale_y_continuous(breaks = c(500,1000,5000,10000,20000,30000)) + 
  scale_x_continuous(breaks = seq(0,100,5))

plot
```
Judging from the above plot, the August_2015 price followed the general price 
trend up to about the 90th percentile. Let's see if we can get some more details 
by applying log transformation to the plot.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Plotting price percentiles, all records vs August 2015, log scale
plot <- ggplot(melted, aes(x = percentile, y = value)) +
  geom_line(aes(color = variable), stat = 'identity') + 
  scale_y_log10(breaks = c(0,100,500,1000,5000,10000,20000,30000)) + #pretty_breaks(5)) + 
  scale_x_continuous(breaks = seq(0,100,5))

plot
```

We get a little bit more details from the log transformation, but the trend 
stays the same:the August 2015 price follows the general trend until about the 
90th percentile, when the August 2015 price starts to become much higher than 
for the same percentiles in the whole dataset. I will plot this one last time, 
zooming in on the top 8 percentiles.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Plotting top 8 price percentiles, all records vs August 2015, log scale
subset(melted, percentile >= 92) %>% 
  ggplot(aes(x = percentile, y = value)) +
  geom_line(aes(color = variable), stat = 'identity') + 
  scale_x_continuous(breaks = seq(90,100,1)) +
  scale_y_continuous(breaks = seq(0,30000,1000))

```

Compared to the August_2015, the 92nd to 99th percentiles for all_records are 
very flat. From the 95th percentile, the August_2015 values are many times 
larger than the values for all_records, only being surpassed at the 100th 
percentile.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Mean vs median price over time, excluding top 1% prices
plot <- ggplot(subset(airbnb, price < quantile(airbnb$price, 0.99)), 
       aes(x = date_collected, y = price)) +
  geom_line(stat = 'summary', fun.y = mean, aes(color = I('blue'))) +
  geom_line(stat = 'summary', fun.y = median,  aes(color = I('forestgreen'))) +
 theme_light() +
  scale_color_manual(name = '', values =c('blue'='blue', 
                                          'forestgreen'='forestgreen'), 
                    labels = c('Mean', 'Median')) +
  ggtitle("price < 99th percentile", subtitle = "Top outliers removed.") + 
  scale_x_date(date_labels = "%b-%y", date_breaks = '6 months')

plot
```

With the most extreme outliers removed, The August 2015 price mean are much 
closer to the mean of the other dates.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Overall satisfaction per neighborhood, mean and median
plot <- ggplot(airbnb, aes(y = overall_satisfaction)) +
  geom_bar(stat = 'summary', fun.y = median,
           aes(x = reorder(neighborhood, overall_satisfaction, 
                           FUN = mean, na.rm = TRUE),
               fill = I('deepskyblue'))) +
    geom_bar(stat = 'summary', fun.y = mean, 
             aes(x = neighborhood, fill = I('gray50'))) +
  coord_flip() +
  labs(x = 'Neighborhood', y='')

  
legend <- scale_fill_manual(name = 'overall_satisfaction', 
                    values=c('gray50'='gray50', 'deepskyblue'='deepskyblue'),
                    labels = c('gray50'='Mean','deepskyblue'='Median'))

plot + legend
```

(gisle)
All of the neighborhoods have a median overall_satisfaction score of either 4.5 
or 5. The mean score varies a little more, although all but two neighborhoods 
score 4 or better.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Plotting price across overall_satisfaction
plot <- ggplot(subset(airbnb), 
       aes(x = overall_satisfaction, y = price)) +
  geom_line(stat = 'summary', fun.y = mean, aes(color = I('blue'))) +
  geom_line(stat = 'summary', fun.y = median,  aes(color = I('forestgreen'))) +
 theme_light()

legend <-  scale_color_manual(name = '', values =c('blue'='blue', 'forestgreen'='forestgreen'), 
                    labels = c('Mean', 'Median'))

plot + legend  
```

Based on the above plot it looks like price has a large impact on the 
overall_satisfaction score. There's also a rather large gap between the median 
and mean prices, especially for overall_satisfaction score 1.

Keep in mind that only 1.5% of the records have an overall_satisfaction score of 
between 1 and 3.5, and 7.5% of the records have a score of 0. It is therefore 
most interesting to look at the price differences in the 4 to 5 
overall_satisfaction range, where there's a fairly clear trend: pricier units 
receive better scores.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Overall_satisfaction over time
plot <- ggplot(airbnb, aes(x = date_collected, y = overall_satisfaction)) +
  geom_line(stat = 'summary', fun.y = mean)

plot
```

The plot showing mean overall_satisfaction over time has a strange dip from the 
end of 2016 until the end of the date range. I suspect this has something to do 
with the remaining 0 values in the dataset. I'll take a closer look at those 
next.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#plot showing counts of dates with overall_satisfaction 0
plot <- ggplot(filter(airbnb, overall_satisfaction == 0), aes(x = factor(date_collected))) +
  geom_bar()

plot

```

Not a single record before 2016-23-12 has an overall_score of 0. Since there is 
a small chance Airbnb actually allowed 0 overall_satisfaction scores starting 
late 2016, I won't do anything further with these values. I will instead avoid 
using this variable in the rest of my analysis.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Plotting price across number of bedrooms
plot <- ggplot(filter(
  airbnb, bedrooms < quantile(airbnb$bedrooms, 0.995, na.rm = TRUE)), 
       aes(x = bedrooms, y = price)) +
  geom_line(stat = 'summary', fun.y = mean, aes(color = I('blue'))) +
  geom_line(stat = 'summary', fun.y = median,  aes(color = I('forestgreen'))) +
  theme_light() +
  labs(caption = 'Excluding top 0.5% bedroom counts.')

legend <- scale_color_manual(name = '', values =c('blue'='blue', 
                                          'forestgreen'='forestgreen'), 
                    labels = c('Mean', 'Median'))

plot + legend
```

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#Plotting price across accomodates
plot <- ggplot(filter(airbnb, accommodates < quantile(airbnb$accommodates, 0.995, na.rm = TRUE)), 
       aes(x = accommodates, y = price)) +
  geom_line(stat = 'summary', fun.y = mean, aes(color = I('blue'))) +
  geom_line(stat = 'summary', fun.y = median,  aes(color = I('forestgreen'))) +
  theme_light() +
  labs(caption = 'Excluding top 0.5% accomodates counts.')

  legend <- scale_color_manual(name = '', values =c('blue'='blue', 'forestgreen'='forestgreen'), 
                    labels = c('Mean', 'Median')) 

  plot + legend
```

Unsurprisingly, units with more bedrooms cost more. The same trend is true for 
accomodations: the more people a unit can accomodate, the pricier the unit tend 
to be.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
#Making proportion table of room_type and date_collected
mutated = airbnb %>%
  group_by(date_collected, room_type) %>%
  summarise (n = n()) %>%
  mutate(Percentage = (n / sum(n)) * 100)

plot <- ggplot(mutated, aes(x=date_collected, fill = room_type, 
                            y = Percentage)) + 
  geom_bar(stat = 'identity', position = 'jitter')

plot
```
Due to the amount of dates, this is not very easy to read. Let's make a line 
chart instead.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

plot <- ggplot(mutated, aes(x=date_collected, color = room_type, 
                            y = Percentage)) +
  geom_line()

plot
```

With the line chart we see a clearer picture. The proportion of Entire home/apt 
units have stayed fairly consistent throughout the time period, while private 
room units have increased and shared room units have decreased. I also notice 
that a few dates at the end of 2015 and in the beginning of 2016 lacks room_type 
information.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}
airbnb %>% 
  filter(room_type == '') %>% 
  group_by(date_collected) %>% 
  summarise(n = n())
```

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Bivariate_Plots}

#bedrooms per room_type
plot <- ggplot(airbnb, aes(x = bedrooms, fill = I('#099DD9') ) ) +
  geom_bar() +
  scale_x_continuous(breaks = seq(0,max(subset(airbnb,!is.na(bedrooms))$bedrooms),1)) +
    geom_text(stat='count',aes(
    label= scales::percent(..prop..)), vjust=-0.5, hjust=0.4, size = 3.2)

plot +
  ylim(0,75000) +
  facet_wrap(~room_type)

```

It is reassuring to see that both of the two room types Private room and Shared 
room have a great majority of 1 bedroom units.

# Bivariate Analysis

> **Tip**: As before, summarize what you found in your bivariate explorations
here. Use the questions below to guide your discussion.

### Talk about some of the relationships you observed in this part of the \
### investigation. How did the feature(s) of interest vary with other features in \
### the dataset?

There is a fairly clear relationship between price and neighborhood. This makes 
sense, as some neighborhoods are more desirable than others. Based on local 
knowledge about San Francisco, it seems like the more central neighborhoods have 
more expensive units. [It will be interesting to see how true this is in a map 
view of price.]

Except for some outlier price points in August 2015, the mean and median prices 
did not vary much over the 4 year period. The prices at the last date of data 
collections were actually lower than at most other dates.

When it comes to overall_satisfaction, there's a fairly clear trend for the 
higher scores: more expensive units receive a higher score. Be aware that the 
overall_satisfaction data is rather fragile, and I had to exclude about 30% of 
the records from overall_satisfaction analysis due to null values.

### Did you observe any interesting relationships between the other features \
(not the main feature(s) of interest)?

There appear to be a relationship between neighborhood and overall satisfaction. 
However, the correlation is not very strong, as all but 3 neighborhoods' mean 
score fall within 0.6 points of eachother.

Less interesting but worth mentioning is that there is a clear correlation 
between price and the number of bedrooms and people a unit can accomadate. 
Considering both of these variable function as proxies for unit size, this 
indicates the following finding: larger units cost more.

### What was the strongest relationship you found?

There are clear correlations between price and the number of bedrooms and price, 
and price and people a unit can accomadate. Both accomadation count and number 
of bedrooms function as proxies for unit size, and indicate the 
following finding: larger units cost more.

# Multivariate Plots Section

> **Tip**: Now it's time to put everything together. Based on what you found in
the bivariate plots section, create a few multivariate plots to investigate
more complex interactions between variables. Make sure that the plots that you
create here are justified by the plots you explored in the previous section. If
you plan on creating any mathematical models, this is the section where you
will do that.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots}
#Preparing common plot functions
plot <- ggplot(data = filter(airbnb, room_type != '')) +
    facet_wrap(~ room_type, nrow = 1) + 
  labs(caption = "Excluding top 5% of x values.") +
  theme(plot.caption = element_text(size = 8))

#Histogram for price
p1 <- plot +
  geom_histogram(aes(x = price, fill = I('gray50'))) +
  xlim(0,quantile(airbnb$price, 0.95))

#Histogram for price_per_bedroom
p2 <- plot +
  geom_histogram(aes(x = price_per_bedroom, fill = I('deepskyblue'))) +
  xlim(0,quantile(airbnb$price_per_bedroom, 0.95, na.rm = TRUE)) 

#Including both plots
grid.arrange(p1,p2, nrow = 2)

```

Entire home/apt units tend to have a higher price than private rooms, while 
shared rooms have the lowest prices of the three room_type categories. This make 
sense, as entire homes tend to be larger than private rooms. While less clear, 
entire homes also tend to have a higher per bedroom price.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots}
#Creating summary table with count, mean and median price for room_type and time 
mutated = filter(airbnb, room_type != '', 
                 price <= quantile(airbnb$price, 0.99)) %>%
  group_by(date_collected, room_type) %>%
  summarise (n = n(), mean_price = mean(price), median_price = median(price))

#Line plot showing prices per room_type over time
plot <- ggplot(mutated, aes(x=date_collected, color = room_type)) +
  geom_line(aes(y = mean_price), linetype = 'solid', show.legend = TRUE) +
  geom_line(aes(y = median_price), linetype = 'longdash', size = 0.5, show.legend = TRUE) +
  labs(y = 'Price', caption = 'Excluding top 1% prices.') +
  ggtitle('Prices per room type over time', 
          subtitle = "Solid lines show mean, dashed lines show median.") +
  theme(plot.caption = element_text(size = 8, hjust = 0), 
        plot.title = element_text(size = 12), 
        plot.subtitle = element_text(size = 9)) +
    scale_color_manual(name='Median', values = c('red','blue','forestgreen'))

plot
```

The prices of entire home units have increased somewhat since the early days. 
Private rooms first have become a little bit cheaper, while shared rooms, 
excluding one date in August 2015, has been fairly stable.

```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots}
#Creating filter for plotting, excluding top 1% room counts.
filtered = filter(airbnb, bedrooms <= quantile(airbnb$bedrooms, 0.99, na.rm = TRUE))

#For annotation purposes, number of observations
# bedroom_counts = filtered %>% 
#   group_by(bedrooms) %>% 
#   summarise(n = n())
# 
# bedroom_counts$n_equals <- paste("n = ", bedroom_counts$n)

plot <- ggplot(data = filtered, aes(x = date_collected, y = price)) + 
  geom_line(stat='summary', fun.y = 'mean', aes(linetype = 'mean')) + 
    geom_line(stat='summary', fun.y = 'median', aes(linetype = 'median')) + 
    scale_linetype_manual(name="",values=c(mean="solid", median="dashed")) +
    theme(plot.title = element_text(size=11),
        legend.position = c(0.9, 0.1), legend.justification = c(1, 0))

plot  +
  ggtitle('Price by number of bedrooms 2013-2017') +
  facet_wrap(~ bedrooms)


```

In the plots above I have excluded the units with 5 or more bedrooms (top 1%). 
With the exception of 4 room units, the median price for all bedroom sizes has 
stayed stable over time. The mean price is affected by the large price outliers 
in August 2015. Excluding that date, the mean price for 0-2 bedroom units have 
stayed stable. The 3 room units had a mean price increase from 2013 until early 
2016, and has since seen a slow mean price decrease of about $100. The mean 
price for 4 room units saw a sharp increase until early 2016, when it stabilized 
around $800.




```{r}
# install.packages("corrgram")
library(corrgram)

corrgram(airbnb, order=NULL, panel=panel.shade, text.panel=panel.txt,
           main="Correlogram")

```

[unclear if keep or remove]


```{r echo=FALSE, echo=FALSE, message=FALSE, warning=FALSE, Multivariate_Plots}

#Creating price bins for use with maps
airbnb$price_bin <- percent_rank(airbnb$price) %>% 
  cut(breaks = seq(0,1,0.25), labels = seq(0.25,1,0.25))
#Setting price 0 to the lowest price bin
airbnb$price_bin[airbnb$price == 0] <- 0.25
```

```{r fig.height = 10, fig.width = 8}
# install.packages("ggmap", type = "source")


# ?get_openstreetmap
# 
# ?ggmap(myMap)
# 
# ?get_map
# 
# qmplot(data = airbnb, x=longitude, y=latitude)

#Creating dataframe to remove duplicate units (same location + same room_id)
room_id_grouped <- group_by(airbnb, room_id, longitude, latitude, price_bin) %>% 
  summarise(n = n())

ggmap(myMap) +
geom_jitter(alpha = 0.1, size = 1, aes(x=longitude, y=latitude), 
           data= room_id_grouped) +
  ggtitle("Location of units per price quartiles") +
  facet_wrap(~price_bin)
  
# map <- get_map(location = "texas", zoom = 6, source = "stamen", urlonly = TRUE)
# 
# map <- get_map(location=c(lon = -98.35, lat = 39.50), zoom = 8, source="google",maptype="roadmap",crop=FALSE)


table(filter(airbnb, is.na(bedrooms))$room_type)#price == 0)#room_id %in% c(2020791,5240693,7221223))

```

In these maps it looks like the most affordable units are spread all over the 
city, while the pricier units are located in the more central areas. 

```{r fig.height = 8, fig.width = 8}

year_grouped <- group_by(airbnb, room_id, longitude, latitude, price = mean(price), year=format(date_collected,"%Y")) %>% 
  summarise(n = n())

nrow(year)

palette_8_colors <- c("#0DA3A0","#2D97AA","#4D8CB4","#6E81BF","#8E76C9","#AF6BD4","#CF60DE","#F055E9")

#Maybe expand/remove, maybe remove
ggmap(myMap) +
geom_point(alpha = 0.1,aes(x=longitude, y=latitude, color = price), data=year_grouped) +
    scale_colour_gradient(low = "white", high = "black") +
  # scale_color_gradientn("Sale Price", 
  #                       colors = palette_8_colors) +
  # scale_color_gradientn(colors = colorRampPalette(c("blue", "red"))(10)) +
  facet_wrap(~year)

?scale_fill_gradient

?as.Date
colorRampPalette(c("blue", "red"))

?get_stamenmap
```

Some dates appear to [use better color schemes].

```{r}
?geom_polygon()
```


```{r}
neighborhood_price_multi <- airbnb %>%
  group_by(neighborhood, room_type) %>% 
  summarise(n = n(), mean = mean(price), median = median(price), 
            min = min(price), max = max(price)) %>% 
  arrange(desc(mean))

ggplot(filter(neighborhood_price_multi, room_type != ''), aes(y = median, x = neighborhood) ) +
  geom_point(aes(x = reorder(neighborhood, median)), size = 1 ) +
  geom_bar(stat = 'identity', width = 0.1, aes(fill = I('gray50'))) +
  ylab('Median price') +
  coord_flip() +
  theme_classic() +
  facet_wrap(~room_type)
```

For room types Entire home/apt and private room, the median price trend of 
neighborhoods seem to match the overall trend, with a few exceptions. The price 
of shared rooms vary much more across neighborhoods, which I suspect is 
partially due to a low amount of data points in some neighborhoods.

```{r fig.height = 8, fig.width = 7}

ggplot(airbnb, aes(x = date_collected, y = price_per_bedroom)) +
  geom_line(stat = 'summary', fun.y = median) +
  theme_light() +
  facet_wrap(~ neighborhood, ncol = 5)

```

```{r fig.height = 8, fig.width = 8}
ggplot(airbnb, aes(x = date_collected)) +
  geom_line(stat = 'summary', fun.y = median, 
            aes(y = price, color = I('blue'))) +
  geom_line(stat = 'summary', fun.y = median, 
            aes(y = price_per_bedroom, color = I('forestgreen'))) +
 theme_light() +
  scale_color_manual(name = '', 
                     values =c('blue'='blue', 'forestgreen'='forestgreen'), 
                    labels = c('Mean', 'Median')) + 
  facet_wrap(~ neighborhood, ncol = 5)


```

Looking at this, Presidio stands out. While the median is fairly stable throughout the 
time period[term], the mean price varies drastically. Let's take a closer look at 
Presidio to figure out what is going on. 

```{r}
Presidio <-
  airbnb %>% 
  subset(neighborhood == 'Presidio') %>% 
  group_by(date_collected) %>% 
  summarise(n = n(), mean = mean(price), median = median(price), min = min(price),
            max = max(price), mean_bedrooms = mean(bedrooms) )

```
 
 Looking at the summary statistics, there seem to be a clear problem with drawing any 
 conclusions from the Presidio data: the sample size per date is just too small, 
 with most dates having less than 10 records [term] [phrasing]. Let's take a look 
 at the sample sizes for all neighborhoods.
```{r}

airbnb %>% subset(neighborhood == 'Presidio') %>% 
  group_by(date_collected) %>% 
  summarise(n = n(), mean = mean(price), median = median(price), min = min(price),
            max = max(price), mean_bedrooms = mean(bedrooms) )

```

```{r}
neighborhood_count <-  
  airbnb %>% 
  group_by(neighborhood) %>% 
  summarise(n = n()) %>% 
  arrange(n)

neighborhood_count
```

Presidio is clearly the most troublesome neighborhood in this regard, having 
nearly 60% fewer records [term] than the second lowest neighborhood. However, 
some of the other neightborhoods might also have too few records to be [statistically 
viable]. Let's take a  closer look at the records with less than 1000 total records.


```{r}

filter_values <- filter(neighborhood_count, n <=1000)$neighborhood

ggplot(filter(airbnb, neighborhood %in% filter_values), aes(x = date_collected)) +
  geom_line(stat = 'count') +
  theme_light() +
  facet_wrap(~ neighborhood, ncol = 5)

```
 
 Too some extent all of these are troubling [expand].
 

```{r fig.height = 8, fig.width = 8}
ggplot(filter(airbnb, !(neighborhood %in% filter_values)), aes(x = date_collected)) +
  geom_line(stat = 'summary', fun.y = median, 
            aes(y = price, color = I('blue'))) +
  geom_line(stat = 'summary', fun.y = median, 
            aes(y = price_per_bedroom, color = I('forestgreen'))) +
 theme_light() +
  scale_color_manual(name = '', 
                     values =c('blue'='blue', 'forestgreen'='forestgreen'), 
                    labels = c('Mean', 'Median')) + 
  facet_wrap(~ neighborhood, ncol = 5)


```
Excluding the low-record neighborhoods shows a clearer relationship between mean 
and median for all neighborhoods. I also notice that except for the first date, 
which we know has much less records compared to the other dates, the median 
prices within neighborhoods stayed fairly stable throughout the time period. The 
same is true for mean, except for Presidio Heights, which had some large outliers 
on certain dates.[rephrase?]



```{r}
ggmap(myMap) +
    geom_jitter(size = 0.1, alpha = 0.01, aes(x=longitude, y=latitude), data=airbnb)

```

```{r fig.height = 6, fig.width = 6}

ggmap(myMap) +
geom_jitter(alpha = 0.01, size = 1, aes(x=longitude, y=latitude), 
           data= filter(airbnb, !is.na(price_bin))) +
  facet_wrap(~price_bin)

```

It looks to me like the most affordable units are widely distrbuted throughout 
all the neighborhoods, while the most expensive units can mostly be found in the 
most central parts of the city. [save for later:]I interpret this to mean that 
the neighborhoods (...).


```{r}
airbnb$price_bin_custom <- 
  airbnb$price %>% 
cut(breaks = c(0,100,200,300,400,500,1000,10000,max(airbnb$price)))

ggplot(airbnb, aes(x = price_bin_custom)) +
  geom_bar()
```

```{r fig.height = 8, fig.width = 6}

ggmap(myMap) +
geom_jitter(alpha = 0.01, size = 0.1, aes(x=longitude, y=latitude), 
           data= filter(airbnb, !is.na(price_bin_custom))) +
  facet_wrap(~price_bin_custom)

```

```{r fig.height = 8, fig.width = 6}

airbnb$price_bin10 <- percent_rank(airbnb$price) %>% 
  cut(breaks = seq(0,1,0.1), labels = seq(0.1,1,0.1))

ggmap(myMap) +
geom_jitter(alpha = 0.01, size = 0.1, aes(x=longitude, y=latitude),
           data= filter(airbnb, !is.na(price_bin10))) +
  facet_wrap(~price_bin10)
# 
# cut(percent_rank(head(airbnb$price,100)), breaks = seq(0,1,0.1))

?facet_wrap
```


# Multivariate Analysis

### Talk about some of the relationships you observed in this part of the \
investigation. Were there features that strengthened each other in terms of \
looking at your feature(s) of interest?

Neighborhood and price have a clear correlation, even after including time as a 
variable. Both median and mean prices vary a fair amount from neighborhood to 
neighborhood, and prices within neighborhoods stayed fairly stable throughout the 
date range.

### Were there any interesting or surprising interactions between features?

I found it interesting how a relatively large dataset can still be too small for 
detailed analysis when you include multiple variables. The clearest example of this 
was how I had to exclude certain neighborhoods from my analysis due to having too 
few data points (less than 10) on certain dates.

### OPTIONAL: Did you create any models with your dataset? Discuss the \
strengths and limitations of your model.

------

# Final Plots and Summary

> **Tip**: You've done a lot of exploration and have built up an understanding
of the structure of and relationships between the variables in your dataset.
Here, you will select three plots from all of your previous exploration to
present here as a summary of some of your most interesting findings. Make sure
that you have refined your selected plots for good titling, axis labels (with
units), and good aesthetic choices (e.g. color, transparency). After each plot,
make sure you justify why you chose each plot by describing what it shows.

### Plot One
```{r echo=FALSE, warning=FALSE Plot_One}
plot1 <- ggplot(airbnb, aes(x = price, fill = I('gray50') ) ) +
  geom_histogram(binwidth = 10) +
  xlim(0,1000) +
  ggtitle("Price distribution") +
  labs(caption = "Excluding top 2% prices.") +
  theme(plot.caption = element_text(size = 8, face = 'italic')) +
  theme_minimal()

plot1

```

### Description One

In this plot the max price is set to 1000, which excludes the 2% most expensive 
units. Even when the large outliers are removed, the price data is still largely 
right-skewed.

### Plot Two
```{r echo=FALSE Plot_Two}

plot2 <- ggplot(neighborhood_price, aes(y = (mean / median), x = neighborhood)) +
# ggplot(neighborhood_price, aes(y = mean, x = neighborhood)) +
  geom_point(aes(x = reorder(neighborhood, (mean / median), FUN = 'identity')), size = 1) +
  geom_bar(stat = 'identity', width = 0.1, aes(fill = I('gray50'))) + 
  ylab('Ratio (mean / median)') +
  xlab('') +
  ggtitle("Median price ratio of mean", subtitle = "per neighborhood") +
  coord_flip() +
  theme_classic()

plot2

```



### Description Two
All the neighborhoods have a higher mean than median. Some neighborhoods have 
drastically higher mean value than median value, indicating right-skewed data or
an issue with outliers (a large amount of outliers or some very large outliers, 
or both.)

### Plot Three
```{r echo=FALSE, Plot_Three}

```


### Description Three

------

# Reflection

> **Tip**: Here's the final step! Reflect on the exploration you performed and
the insights you found. What were some of the struggles that you went through?
What went well? What was surprising? Make sure you include an insight into
future work that could be done with the dataset.

I have intentionally chosen not to look at changes for institution_id and 
room_id over time, as I have considered it to be outside the scope of this 
project. It would be interesting to find out how ownership changes over time, 
and to see if any of the variables for indidividual units ever change.

> **Tip**: Don't forget to remove this, and the other **Tip** sections before
saving your final work and knitting the final report!